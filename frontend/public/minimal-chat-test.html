<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chat-container { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin: 10px 0; }
        .chat-input { width: 70%; padding: 10px; }
        .send-btn { padding: 10px 20px; margin-left: 10px; }
        .message { margin: 10px 0; padding: 8px; border-radius: 4px; }
        .user { background: #e3f2fd; text-align: right; }
        .assistant { background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>Minimal Chat Test</h1>
    
    <div class="chat-container">
        <div id="chatMessages" class="chat-messages">
            <div class="message assistant">Hello! I'm ready to help you. Type a message below.</div>
        </div>
        
        <div>
            <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." />
            <button id="sendButton" class="send-btn">Send</button>
        </div>
    </div>
    
    <div id="status">Initializing...</div>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ckrtquhwlvpmpgrfemmb.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrcnRxdWh3bHZwbXBncmZlbW1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NTE5MjQsImV4cCI6MjA2NTIyNzkyNH0.EKkuLjGdt3BJckM9XtboDCknG5ggt0xwcAI_jI8Al6k';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
        
        let currentChatId = null;
        
        // API utilities
        async function apiCall(url, options = {}) {
            const token = await getAuthToken();
            
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response;
        }

        async function getAuthToken() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                return session?.access_token;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }
        
        function addMessage(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            console.log('Sending message:', message);
            
            // Clear input
            chatInput.value = '';
            
            // Add user message
            addMessage('user', message);
            
            // Show typing indicator
            addMessage('assistant', 'Thinking...');
            
            try {
                // Create or get chat ID
                if (!currentChatId) {
                    try {
                        const response = await apiCall('/api/v1/chats', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: 'Test Chat' })
                        });
                        const data = await response.json();
                        currentChatId = data.id;
                        console.log('Created chat ID:', currentChatId);
                    } catch (error) {
                        console.log('Using temporary chat ID due to error:', error.message);
                        currentChatId = 'temp_' + Date.now();
                    }
                }
                
                // Send to AI
                const response = await apiCall('/api/v1/ai/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: message }],
                        temperature: 0.7,
                        max_tokens: 1024,
                        chat_id: currentChatId,
                        save_conversation: true
                    })
                });
                
                const data = await response.json();
                console.log('AI response:', data);
                
                // Remove thinking indicator
                const messages = document.querySelectorAll('.message');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.textContent === 'Thinking...') {
                    lastMessage.remove();
                }
                
                // Add AI response
                if (data.choices && data.choices[0]) {
                    addMessage('assistant', data.choices[0].message.content);
                    document.getElementById('status').textContent = 'Chat working correctly!';
                } else {
                    addMessage('assistant', 'Sorry, I got an unexpected response format.');
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Remove thinking indicator
                const messages = document.querySelectorAll('.message');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.textContent === 'Thinking...') {
                    lastMessage.remove();
                }
                
                addMessage('assistant', `Error: ${error.message}`);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        }
        
        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            
            sendButton.addEventListener('click', sendMessage);
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('status').textContent = 'Ready! Type a message and press Send.';
            console.log('Minimal chat test initialized');
        });
    </script>
</body>
</html>